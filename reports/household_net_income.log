Traceback (most recent call last):
  File "/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/jupyter_cache/executors/utils.py", line 51, in single_nb_execution
    executenb(
  File "/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/nbclient/client.py", line 1204, in execute
    return NotebookClient(nb=nb, resources=resources, km=km, **kwargs).execute()
  File "/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/nbclient/util.py", line 84, in wrapped
    return just_run(coro(*args, **kwargs))
  File "/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/nbclient/util.py", line 62, in just_run
    return loop.run_until_complete(coro)
  File "/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/asyncio/base_events.py", line 647, in run_until_complete
    return future.result()
  File "/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/nbclient/client.py", line 663, in async_execute
    await self.async_execute_cell(
  File "/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/nbclient/client.py", line 965, in async_execute_cell
    await self._check_raise_for_error(cell, cell_index, exec_reply)
  File "/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/nbclient/client.py", line 862, in _check_raise_for_error
    raise CellExecutionError.from_cell_and_msg(cell, exec_reply_content)
nbclient.exceptions.CellExecutionError: An error occurred while executing the following cell:
------------------
from policyengine_canada import Microsimulation, Simulation
from policyengine_core.reforms import Reform
from policyengine_canada.model_api import *
import pandas as pd

YEAR = 2023


def make_hh(adults, children, child_age):
    people = dict(head=dict(age=30))
    members = ["head"]
    if adults == 2:
        people["spouse"] = dict(age=30)
        members += ["spouse"]
    for i in range(children):
        people[f"child{i}"] = dict(age=child_age)
        members += [f"child{i}"]
    return dict(
        people=people,
        households=dict(household=dict(members=members, province="ONTARIO")),
        # Same impact for households with $250k+ income, so show up to $300k.
        # $1k increments.
        axes=[[dict(name="employment_income", count=301, min=0, max=300_000)]],
    )


l = []
for adults in [1, 2]:
    for children in [0, 1, 2, 3]:
        for child_age in [1]:
            hh = make_hh(adults, children, child_age)
            baseline_hh = Simulation(situation=hh)
            l.append(
                pd.DataFrame(
                    dict(
                        adults=adults,
                        children=children,
                        child_age=child_age,
                        # Reshape combined array to get head's varied earnings.
                        employment_income=baseline_hh.calculate(
                            "employment_income", YEAR
                        )[0 :: (adults + children)],
                        household_net_income=baseline_hh.calculate(
                            "household_net_income", YEAR
                        ),
                        mtr=baseline_hh.calculate("marginal_tax_rate", YEAR)[
                            0 :: (adults + children)
                        ],
                    )
                )
            )

df = pd.concat(l)
df
------------------

[0;31m---------------------------------------------------------------------------[0m
[0;31mVariableNotFoundError[0m                     Traceback (most recent call last)
File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation_builder.py:536[0m, in [0;36mSimulationBuilder.init_variable_values[0;34m(self, entity, instance_object, instance_id)[0m
[1;32m    535[0m [38;5;28;01mtry[39;00m:
[0;32m--> 536[0m     [43mentity[49m[38;5;241;43m.[39;49m[43mcheck_variable_defined_for_entity[49m[43m([49m[43mvariable_name[49m[43m)[49m
[1;32m    537[0m [38;5;28;01mexcept[39;00m (
[1;32m    538[0m     [38;5;167;01mValueError[39;00m
[1;32m    539[0m ) [38;5;28;01mas[39;00m e:  [38;5;66;03m# The variable is defined for another entity[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/entities/entity.py:34[0m, in [0;36mEntity.check_variable_defined_for_entity[0;34m(self, variable_name)[0m
[1;32m     33[0m [38;5;28;01mdef[39;00m [38;5;21mcheck_variable_defined_for_entity[39m([38;5;28mself[39m, variable_name: [38;5;28mstr[39m) [38;5;241m-[39m[38;5;241m>[39m [38;5;28;01mNone[39;00m:
[0;32m---> 34[0m     variable_entity [38;5;241m=[39m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mget_variable[49m[43m([49m
[1;32m     35[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mcheck_existence[49m[38;5;241;43m=[39;49m[38;5;28;43;01mTrue[39;49;00m
[1;32m     36[0m [43m    [49m[43m)[49m[38;5;241m.[39mentity
[1;32m     37[0m     [38;5;66;03m# Should be this:[39;00m
[1;32m     38[0m     [38;5;66;03m# if variable_entity is not self:[39;00m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/entities/entity.py:29[0m, in [0;36mEntity.get_variable[0;34m(self, variable_name, check_existence)[0m
[1;32m     28[0m [38;5;28;01mdef[39;00m [38;5;21mget_variable[39m([38;5;28mself[39m, variable_name: [38;5;28mstr[39m, check_existence: [38;5;28mbool[39m [38;5;241m=[39m [38;5;28;01mFalse[39;00m):
[0;32m---> 29[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43m_tax_benefit_system[49m[38;5;241;43m.[39;49m[43mget_variable[49m[43m([49m
[1;32m     30[0m [43m        [49m[43mvariable_name[49m[43m,[49m[43m [49m[43mcheck_existence[49m
[1;32m     31[0m [43m    [49m[43m)[49m

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/taxbenefitsystems/tax_benefit_system.py:479[0m, in [0;36mTaxBenefitSystem.get_variable[0;34m(self, variable_name, check_existence)[0m
[1;32m    478[0m [38;5;28;01mif[39;00m [38;5;129;01mnot[39;00m found [38;5;129;01mand[39;00m check_existence:
[0;32m--> 479[0m     [38;5;28;01mraise[39;00m VariableNotFoundError(variable_name, [38;5;28mself[39m)
[1;32m    480[0m [38;5;28;01mreturn[39;00m found

[0;31mVariableNotFoundError[0m: You tried to calculate or to set a value for variable 'province', but it was not found in the loaded tax and benefit system (policyengine-canada@0.41.0).
Are you sure you spelled 'province' correctly?
If this code used to work and suddenly does not, this is most probably linked to an update of the tax and benefit system.
Look at its changelog to learn about renames and removals and update your code. If it is an official package,
it is probably available on <https://github.com/openfisca/policyengine-canada/blob/master/CHANGELOG.md>.

During handling of the above exception, another exception occurred:

[0;31mSituationParsingError[0m                     Traceback (most recent call last)
Cell [0;32mIn[1], line 32[0m
[1;32m     30[0m         [38;5;28;01mfor[39;00m child_age [38;5;129;01min[39;00m [[38;5;241m1[39m]:
[1;32m     31[0m             hh [38;5;241m=[39m make_hh(adults, children, child_age)
[0;32m---> 32[0m             baseline_hh [38;5;241m=[39m [43mSimulation[49m[43m([49m[43msituation[49m[38;5;241;43m=[39;49m[43mhh[49m[43m)[49m
[1;32m     33[0m             l[38;5;241m.[39mappend(
[1;32m     34[0m                 pd[38;5;241m.[39mDataFrame(
[1;32m     35[0m                     [38;5;28mdict[39m(
[0;32m   (...)[0m
[1;32m     50[0m                 )
[1;32m     51[0m             )
[1;32m     53[0m df [38;5;241m=[39m pd[38;5;241m.[39mconcat(l)

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation.py:122[0m, in [0;36mSimulation.__init__[0;34m(self, tax_benefit_system, populations, situation, dataset, dataset_year, reform)[0m
[1;32m    120[0m     builder [38;5;241m=[39m SimulationBuilder()
[1;32m    121[0m     builder[38;5;241m.[39mdefault_period [38;5;241m=[39m [38;5;28mself[39m[38;5;241m.[39mdefault_input_period
[0;32m--> 122[0m     [43mbuilder[49m[38;5;241;43m.[39;49m[43mbuild_from_dict[49m[43m([49m[38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mtax_benefit_system[49m[43m,[49m[43m [49m[43msituation[49m[43m,[49m[43m [49m[38;5;28;43mself[39;49m[43m)[49m
[1;32m    123[0m     [38;5;28mself[39m[38;5;241m.[39mhas_axes [38;5;241m=[39m builder[38;5;241m.[39mhas_axes
[1;32m    125[0m [38;5;28;01mif[39;00m populations [38;5;129;01mis[39;00m [38;5;129;01mnot[39;00m [38;5;28;01mNone[39;00m:

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation_builder.py:82[0m, in [0;36mSimulationBuilder.build_from_dict[0;34m(self, tax_benefit_system, input_dict, simulation)[0m
[1;32m     75[0m input_dict [38;5;241m=[39m [38;5;28mself[39m[38;5;241m.[39mexplicit_singular_entities(
[1;32m     76[0m     tax_benefit_system, input_dict
[1;32m     77[0m )
[1;32m     78[0m [38;5;28;01mif[39;00m [38;5;28many[39m(
[1;32m     79[0m     key [38;5;129;01min[39;00m tax_benefit_system[38;5;241m.[39mentities_plural()
[1;32m     80[0m     [38;5;28;01mfor[39;00m key [38;5;129;01min[39;00m input_dict[38;5;241m.[39mkeys()
[1;32m     81[0m ):
[0;32m---> 82[0m     [38;5;28;01mreturn[39;00m [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mbuild_from_entities[49m[43m([49m
[1;32m     83[0m [43m        [49m[43mtax_benefit_system[49m[43m,[49m[43m [49m[43minput_dict[49m[43m,[49m[43m [49m[43msimulation[49m
[1;32m     84[0m [43m    [49m[43m)[49m
[1;32m     85[0m [38;5;28;01melse[39;00m:
[1;32m     86[0m     [38;5;28;01mreturn[39;00m [38;5;28mself[39m[38;5;241m.[39mbuild_from_variables(
[1;32m     87[0m         tax_benefit_system, input_dict, simulation
[1;32m     88[0m     )

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation_builder.py:163[0m, in [0;36mSimulationBuilder.build_from_entities[0;34m(self, tax_benefit_system, input_dict, simulation)[0m
[1;32m    161[0m instances_json [38;5;241m=[39m input_dict[38;5;241m.[39mget(entity_class[38;5;241m.[39mplural)
[1;32m    162[0m [38;5;28;01mif[39;00m instances_json [38;5;129;01mis[39;00m [38;5;129;01mnot[39;00m [38;5;28;01mNone[39;00m:
[0;32m--> 163[0m     [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43madd_group_entity[49m[43m([49m
[1;32m    164[0m [43m        [49m[38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43mpersons_plural[49m[43m,[49m
[1;32m    165[0m [43m        [49m[43mpersons_ids[49m[43m,[49m
[1;32m    166[0m [43m        [49m[43mentity_class[49m[43m,[49m
[1;32m    167[0m [43m        [49m[43minstances_json[49m[43m,[49m
[1;32m    168[0m [43m    [49m[43m)[49m
[1;32m    169[0m [38;5;28;01melse[39;00m:
[1;32m    170[0m     [38;5;28mself[39m[38;5;241m.[39madd_default_group_entity(persons_ids, entity_class)

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation_builder.py:472[0m, in [0;36mSimulationBuilder.add_group_entity[0;34m(self, persons_plural, persons_ids, entity, instances_json)[0m
[1;32m    465[0m             person_role [38;5;241m=[39m (
[1;32m    466[0m                 role[38;5;241m.[39msubroles[index_within_role]
[1;32m    467[0m                 [38;5;28;01mif[39;00m role[38;5;241m.[39msubroles
[1;32m    468[0m                 [38;5;28;01melse[39;00m role
[1;32m    469[0m             )
[1;32m    470[0m             [38;5;28mself[39m[38;5;241m.[39mroles[entity[38;5;241m.[39mplural][person_index] [38;5;241m=[39m person_role
[0;32m--> 472[0m     [38;5;28;43mself[39;49m[38;5;241;43m.[39;49m[43minit_variable_values[49m[43m([49m[43mentity[49m[43m,[49m[43m [49m[43mvariables_json[49m[43m,[49m[43m [49m[43minstance_id[49m[43m)[49m
[1;32m    474[0m [38;5;28;01mif[39;00m persons_to_allocate:
[1;32m    475[0m     entity_ids [38;5;241m=[39m entity_ids [38;5;241m+[39m [38;5;28mlist[39m(persons_to_allocate)

File [0;32m/opt/hostedtoolcache/Python/3.9.16/x64/lib/python3.9/site-packages/policyengine_core/simulations/simulation_builder.py:542[0m, in [0;36mSimulationBuilder.init_variable_values[0;34m(self, entity, instance_object, instance_id)[0m
[1;32m    540[0m     [38;5;28;01mraise[39;00m SituationParsingError(path_in_json, e[38;5;241m.[39margs[[38;5;241m0[39m])
[1;32m    541[0m [38;5;28;01mexcept[39;00m VariableNotFoundError [38;5;28;01mas[39;00m e:  [38;5;66;03m# The variable doesn't exist[39;00m
[0;32m--> 542[0m     [38;5;28;01mraise[39;00m SituationParsingError(path_in_json, [38;5;28mstr[39m(e), code[38;5;241m=[39m[38;5;241m404[39m)
[1;32m    544[0m instance_index [38;5;241m=[39m [38;5;28mself[39m[38;5;241m.[39mget_ids(entity[38;5;241m.[39mplural)[38;5;241m.[39mindex(instance_id)
[1;32m    546[0m [38;5;28;01mif[39;00m [38;5;129;01mnot[39;00m [38;5;28misinstance[39m(variable_values, [38;5;28mdict[39m):

[0;31mSituationParsingError[0m: {'households': {'household': {'province': "You tried to calculate or to set a value for variable 'province', but it was not found in the loaded tax and benefit system (policyengine-canada@0.41.0). Are you sure you spelled 'province' correctly? If this code used to work and suddenly does not, this is most probably linked to an update of the tax and benefit system. Look at its changelog to learn about renames and removals and update your code. If it is an official package, it is probably available on <https://github.com/openfisca/policyengine-canada/blob/master/CHANGELOG.md>."}}}
SituationParsingError: {'households': {'household': {'province': "You tried to calculate or to set a value for variable 'province', but it was not found in the loaded tax and benefit system (policyengine-canada@0.41.0). Are you sure you spelled 'province' correctly? If this code used to work and suddenly does not, this is most probably linked to an update of the tax and benefit system. Look at its changelog to learn about renames and removals and update your code. If it is an official package, it is probably available on <https://github.com/openfisca/policyengine-canada/blob/master/CHANGELOG.md>."}}}

